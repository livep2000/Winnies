$.widget("plugins.filemanager",$.winnies.pluginSuperwidget,{doLog:!0,version:"1.0.0",uniqueLabel:null,containerDiv:null,appTabLayout:null,addressBar:null,plugins:["unique","contextmenu","changed"],crossIndex:null,fileTree:null,fileTreeInst:null,directoryTree:null,fileRootId:null,dirTreeInst:null,itWasMe:!1,options:{startPath:"/home",addressBar:!0,filePane:!0,fileBuffer:null},tmpPath:"",_contentLoaded:function(){oldConsole.log(this.options);var a=this;this.crossIndex=new core.util.crossIndex({indexes:{relativePath:"",nodeId:""},data:{node:{}}}),this.setupLayout(),this.createDirTree(),this.createFileTree(),this.directoryTree.on("changed.jstree",function(b,c){"ready"===c.action&&(a.logging("jstree :: tree ready"),a.addCrossindexItem("/",c.selected[0],{populated:!1,opened:!1}),a.expandTo(a.options.startPath,function(b,c){a.populateFileTree(c,function(b,c){a.dirTreeEvents(),a.fileSystemChangedEvents()})}))})},dirTreeEvents:function(){var a=this;this.directoryTree.on("select_node.jstree",function(b,c){var d=c.node.id;a.crossIndex.find(d,"nodeId",function(b,e){a.populateFileTree(c.node,function(b,c){var f=e.indexes.relativePath;a.options.addressBar&&a.addressBar.text(f),a._trigger("activatedir",null,{err:null,path:f}),e.data.populated?a.itWasMe=!1:a.expandDirNode(d,f,function(b,c){a.itWasMe=!1,b&&console.log(b)})})})}),this.directoryTree.on("close_node.jstree",function(b,c){a.dirTreeInst.deselect_all(!0),a.dirTreeInst.select_node(c.node),a.crossIndex.update(c.node.id,"nodeId",{data:{opened:!1}})}),this.directoryTree.on("open_node.jstree",function(b,c){a.dirTreeInst.deselect_all(!0),a.dirTreeInst.select_node(c.node),a.crossIndex.update(c.node.id,"nodeId",{data:{opened:!0}})})},fileSystemChangedEvents:function(){var a=this;this.directoryTree.on("create_node.jstree",function(b,c,d,e){a.changes(b,c,d,e,"dir")}),this.directoryTree.on("rename_node.jstree",function(b,c,d,e){a.changes(b,c,d,e,"dir")}),this.directoryTree.on("delete_node.jstree",function(b,c,d,e){a.changes(b,c,d,e,"dir")}),this.directoryTree.on("move_node.jstree",function(b,c,d,e){a.changes(b,c,d,e,"dir")}),this.directoryTree.on("copy_node.jstree",function(b,c,d,e){a.changes(b,c,d,e,"dir")}),this.fileTree.on("create_node.jstree",function(b,c,d,e){a.changes(b,c,d,e,"file")}),this.fileTree.on("rename_node.jstree",function(b,c,d,e){a.changes(b,c,d,e,"file")}),this.fileTree.on("delete_node.jstree",function(b,c,d,e){a.changes(b,c,d,e,"file")}),this.fileTree.on("move_node.jstree",function(b,c,d,e){a.changes(b,c,d,e,"file")}),this.fileTree.on("copy_node.jstree",function(b,c,d,e){a.changes(b,c,d,e,"file")}),$(core.system).on("filesystemchanged."+this.uniqueLabel,function(b,c){a.crossIndex.find(c.relativePath,"relativePath",function(b,d){if(!b){var e=d.indexes.nodeId;if("dir"===c.tree){if($(a.directoryTree).attr("id")===c.treeId){if("delete_node"===c.type)a.crossIndex.remove(e,"nodeId",function(a,b){return a?core.system.alertBox(a,!1):void 0});else if("create_node"===c.type){if(a.itWasMe)return;if(c.relativePath.endsWith("/"))var f=c.relativePath+c.newInfo+"/";else var f=c.relativePath+"/"+c.newInfo+"/";a.addCrossindexItem(f,c.newId,{populated:!1,opened:!1}),BVFS.fs.mkdir(f,function(a){return a?core.system.alertBox(a.message,!1):void 0})}else if("rename_node"===c.type){for(var g=c.relativePath.split("/"),h="",i=0;i<g.length-2;i++)h+=g[i],h+="/";h+=c.newInfo+"/",a.crossIndex.find(c.relativePath,"relativePath",function(b,d){$.each(d,function(b,d){var e=d.indexes.relativePath.replace(c.relativePath,h);a.crossIndex.update(d.indexes.relativePath,"relativePath",{indexes:{relativePath:e}})})},{l:!0,"in":!0}),c.relativePath!==h&&BVFS.fs.rename(c.relativePath,h,function(a){return a?core.system.alertBox(a.message,!1):void 0})}return}var e=d.indexes.nodeId;if("delete_node"===c.type)a.itWasMe=!0,a.dirTreeInst.delete_node(e),a.crossIndex.remove(c.relativePath,"relativePath",function(a,b){return a?core.system.alertBox(a,!1):void 0});else if("create_node"===c.type){if(a.itWasMe=!0,c.relativePath.endsWith("/"))var f=c.relativePath+c.newInfo+"/";else var f=c.relativePath+"/"+c.newInfo+"/";var j=a.dirTreeInst.create_node(e,{type:"folder",text:c.newInfo});a.addCrossindexItem(f,j,{populated:!1,opened:!1})}else if("rename_node"===c.type){a.itWasMe=!0;for(var g=c.relativePath.split("/"),h="",i=0;i<g.length-2;i++)h+=g[i],h+="/";h+=c.newInfo+"/",a.crossIndex.find(c.relativePath,"relativePath",function(b,d){$.each(d,function(b,d){var e=d.indexes.relativePath.replace(c.relativePath,h);a.crossIndex.update(d.indexes.relativePath,"relativePath",{indexes:{relativePath:e}})})},{l:!0,"in":!0}),a.dirTreeInst.rename_node(e,c.newInfo)}else"copy_node"===c.type||"move_node"===c.type}else if("file"===c.tree)if($(a.fileTree).attr("id")===c.treeId)if("delete_node"===c.type)a.crossIndex.remove(e,"nodeId",function(a,b){return a?core.system.alertBox(a,!1):void 0});else if("create_node"===c.type){if(a.itWasMe)return;var k=d.indexes.relativePath+"New file";BVFS.fs.open(k,"w",function(b,d){a.addCrossindexItem(k,c.newId,{populated:!1,opened:!1}),BVFS.fs.close(d)})}else if("rename_node"===c.type){for(var g=c.relativePath.split("/"),h="",i=0;i<g.length-1;i++)h+=g[i],h+="/";h+=c.newInfo,a.crossIndex.update(e,"nodeId",{indexes:{relativePath:h}}),c.relativePath!==h&&(console.log("rename: "+c.relativePath),console.log("to: "+h),BVFS.fs.rename(c.relativePath,h,function(a){return a?core.system.alertBox("*1* "+a.message,!1):void 0}))}else"copy_node"===c.type||"move_node"===c.type;else if(oldConsole.log("Triggered from remote: "+c.type),"delete_node"===c.type)a.itWasMe=!0,a.fileTreeInst.delete_node(e),a.crossIndex.remove(e,"nodeId",function(a,b){return a?core.system.alertBox(a,!1):void 0});else if("create_node"===c.type){a.itWasMe=!0,a.fileTreeInst.deselect_all(!0);var k=d.indexes.relativePath+"New file",l=a.createNode("New file","jstree-file",null,!0,!1),j=a.fileTreeInst.create_node("#",l);a.fileTreeInst.select_node(j),a.addCrossindexItem(k,j,{populated:!1,opened:!1})}else if("rename_node"===c.type){a.itWasMe=!0;for(var g=c.relativePath.split("/"),h="",i=0;i<g.length-1;i++)h+=g[i],h+="/";h+=c.newInfo,a.crossIndex.update(e,"nodeId",{indexes:{relativePath:h}}),a.fileTreeInst.rename_node(e,c.newInfo)}else"copy_node"===c.type||"move_node"===c.type}})})},populateFileTree:function(a,b){if(!this.options.filePane)return!1;for(var c=this,d=c.fileTreeInst.get_node("#").children.slice(),e=0;e<d.length;e++)c.itWasMe=!0,c.fileTreeInst.delete_node(d[e]),c.crossIndex.remove(d[e],"nodeId");this.crossIndex.find(a.id,"nodeId",function(a,d){if(a)return core.system.alertBox(a,!1);c.options.addressBar&&c.addressBar.text(d.indexes.relativePath);var e=d.indexes.relativePath;BVFS.sh.ls(e,function(a,d){return a?b(a.message,null):void async.each(d,function(a,b){if("FILE"===a.type){c.itWasMe=!0;var d=e+a.path,f=c.createNode(a.path,"jstree-file",{filePath:d,entryPath:a.path},!1,!1),g=c.fileTreeInst.create_node("#",f);c.addCrossindexItem(d,g,{directory:a.path})}b()},function(a){return c.itWasMe=!1,b(a,!0)})})})},createDirTree:function(){var a=this;this.directoryTree.jstree({plugins:a.plugins,contextmenu:{items:function(b){return a.createContextMenu(b)}},core:{check_callback:!0,themes:{stripes:!0},data:function(b,c){var d=a.createNode("/","jstree-folder",null,!0,!1);c.call(this,d)}}}),this.dirTreeInst=this.directoryTree.jstree(!0)},createFileTree:function(){var a=this;this.fileTree&&this.fileTree.jstree("destroy"),this.fileTree.jstree({plugins:a.plugins,contextmenu:{items:function(b){return a.createFileContextMenu(b)}},core:{check_callback:!0,themes:{stripes:!0},data:null}}),this.fileTreeInst=this.fileTree.jstree(!0),this.fileTree.on("select_node.jstree",function(b,c){var d=c.node.id;a.crossIndex.find(d,"nodeId",function(b,c){var d=c.indexes.relativePath;a.options.addressBar&&a.addressBar.text(d),a._trigger("activatefile",null,{err:null,path:d})})})},createFileContextMenu:function(a){var b=this,c={openFile:{label:"Open file",action:function(c){b.openFile(c,a)},_disabled:!0,separator_after:!0},createFile:{label:"New file",action:function(c){b.createFile(c,a)}},renameFile:{label:"Rename file",action:function(c){b.renameFile(c,a)}},DeleteFile:{label:"Delete file",action:function(c){b.deleteFile(c,a)},separator_after:!0}};return c.edit={label:"Edit"},c.edit.submenu={copyFile:{label:"Copy",action:function(c){b.copyFile(c,a)}},cutFile:{label:"Cut",action:function(c){b.cutFile(c,a)}},pasteFile:{label:"Paste",action:function(c){b.pasteFile(c,a)},_disabled:!0}},c},openFile:function(a,b){console.log("open file"),this.notReadyAlert()},copyFile:function(a,b){console.log("copy file"),this.notReadyAlert()},cutFile:function(a,b){console.log("cut file"),this.notReadyAlert()},pasteFile:function(a,b){console.log("paste file"),this.notReadyAlert()},createFile:function(a,b){var c=this;c.fileTreeInst.deselect_all(!0);var d=this.createNode("New file","jstree-file",null,!0,!1),e=this.fileTreeInst.create_node("#",d);c.fileTreeInst.select_node(e),c.fileTreeInst.edit(e)},renameFile:function(a,b){this.fileTreeInst.edit(b)},deleteFile:function(a,b){var c=this;this.crossIndex.find(b.id,"nodeId",function(a,d){return a?core.system.alertBox(a,!1):void BVFS.fs.unlink(d.indexes.relativePath,function(a){return a?core.system.alertBox(a.message,!1):void c.fileTreeInst.delete_node(b.id)})})},createContextMenu:function(a){var b=this,c={};return c.SaveInfolder={label:"Save file",action:function(c){b.saveInFolder(c,a)},separator_after:!0},null===b.options.fileBuffer&&(c.SaveInfolder._disabled=!0),c.CreateFolder={label:"Add folder",action:function(c){b.createFolder(c,a)}},c.Rename={label:"Rename folder",action:function(c){b.renameFolder(c,a)}},c.Delete={label:"Delete folder",action:function(c){b.deleteFolder(c,a)},separator_after:!0},c.edit={label:"Edit"},c.edit.submenu={copyFolder:{label:"Copy",action:function(c){b.copyFolder(c,a)}},cutFolder:{label:"Cut",action:function(c){b.cutFolder(c,a)}},pasteFolder:{label:"Paste",action:function(c){b.pasteFolder(c,a)},_disabled:!0}},c},saveInFolder:function(a,b){console.log("save file")},renameFolder:function(a,b){this.dirTreeInst.edit(b)},createFolder:function(a,b){var c=this.dirTreeInst.create_node(b.id,{type:"folder"});this.dirTreeInst.edit(c)},deleteFolder:function(a,b){var c=this;this.crossIndex.find(b.id,"nodeId",function(a,d){return a?core.system.alertBox(a,!1):void BVFS.fs.rmdir(d.indexes.relativePath,function(a){return a?core.system.alertBox(a.message,!1):void c.dirTreeInst.delete_node(b.id)})})},copyFolder:function(a,b){this.notReadyAlert()},cutFolder:function(a,b){this.notReadyAlert()},pasteFolder:function(a,b){this.notReadyAlert()},changes:function(a,b,c,d,e){if(this.itWasMe)return void(this.itWasMe=!1);if("dir"==e)var f=$(this.directoryTree).attr("id");else var f=$(this.fileTree).attr("id");var g;g="create_node"===a.type?b.parent:b.node.id,"#"===g&&(g=this.dirTreeInst.get_selected()[0]);var h={type:a.type,treeId:f,tree:e};this.crossIndex.find(g,"nodeId",function(c,d){return c?console.error(c):("create_node"===a.type?(h.relativePath=d.indexes.relativePath,h.newInfo=b.node.text,h.newId=b.node.id):"rename_node"===a.type?(h.relativePath=d.indexes.relativePath,h.oldInfo=b.old,h.newInfo=b.text):"delete_node"===a.type?h.relativePath=d.indexes.relativePath:"move_node"===a.type||"copy_node"===a.type||console.error(a.type+" Not recognized"),void core.system.fileChanged(h))})},expandEachSync:function(a,b,c){var d=this;if(!b)var b=0;this.tmpPath?this.tmpPath+=a[b]+"/":this.tmpPath="/",d.crossIndex.find(d.tmpPath,"relativePath",function(e,f){b+=1,e?core.system.alertBox(e,!1):d.expandDirNode(f.indexes.nodeId,d.tmpPath,function(e,g){if(b<a.length)d.expandEachSync(a,b,c);else{var h=d.dirTreeInst.get_node(f.indexes.nodeId);d.dirTreeInst.deselect_all(!0),d.dirTreeInst.select_node(h),c(e,h)}})})},expandTo:function(a,b){var c=["/"];"/"!==a&&(c=a.split("/")),this.tmpPath="",this.expandEachSync(c,0,function(a,c){b(a,c)})},createNode:function(a,b,c,d,e){var f={icon:b,text:a,data:c,state:{opened:e,selected:d}};return f},expandDirNode:function(a,b,c){var d=this,e=d.dirTreeInst.get_node(a);BVFS.sh.ls(b,function(f,g){if(f)throw f;async.each(g,function(a,c){if(d.itWasMe=!0,"DIRECTORY"===a.type){var f=d.createNode(a.path,"jstree-folder",null,!1,!0),g=b+a.path+"/",h=d.dirTreeInst.create_node(e,f,"last");d.addCrossindexItem(g,h,{populated:!1,opened:!1})}c()},function(b){d.crossIndex.update(a,"nodeId",{data:{populated:!0,opened:!0}},function(a,b){c(a,b)})})})},addCrossindexItem:function(a,b,c){var d=this.crossIndex.baseObject();d.indexes.relativePath=a,d.indexes.nodeId=b,d.data=c,this.crossIndex.add(d)},setupLayout:function(){var a=this;$.jstree.defaults.core.data=!0,this.element.css("overflow","hidden"),this.element.addClass("nonselectable"),this.uniqueLabel=core.util.guid(),this.addressBar=this.fec("addressbar"),this.addressBar.attr({contenteditable:!0}),this.addressBar.keypress(function(a){if(13==a.keyCode){event.preventDefault();var b=$(this).text();console.log(b)}}),this.containerDiv=this.fec("container"),this.containerDiv.attr({id:this.uniqueLabel}),this.appTabLayout=this.containerDiv.layout({initClosed:!1,applyDefaultStyles:!0,paneClass:a.uniqueLabel+"-pane"}),this.containerDiv.height(this.element.height()),this.appTabLayout.options.east.size=this.element.width()-240,this.appTabLayout.options.north.resizable=!1,this.appTabLayout.resizeAll(),this.options.filePane?(this.appTabLayout.open("east"),this.filePane=this.fec("files"),this.fileTree=this.fec("filetree"),this.fileTree.attr({id:"filetree"+this.uniqueLabel})):this.appTabLayout.hide("east"),this.options.addressBar?this.appTabLayout.open("north"):this.appTabLayout.hide("north"),this.directoryTree=this.fec("directorytree"),this.directoryTree.attr({id:"tree"+this.uniqueLabel})},resizeAll:function(a){this.containerDiv.height(this.element.height()),this.appTabLayout.resizeAll()},_setOption:function(a,b){if(oldConsole.log("OPTION",a,b),"resizeAll"===a&&this.resizeAll(b),"saveFile"===a){var c=this.addressBar.text(),d=c+this.options.fileName,e=this.options.fileBuffer;console.log("PATH: "+d),BVFS.fs.open(d,"w",function(a,b){function c(a,g,h){h=h||e.length-f,BVFS.fs.write(b,e,a,h,g,function(a,e){if(a)throw error;f+=e,d>f?c(f,null):BVFS.fs.close(b)})}if(a)return console.error(a.message);var d=e.length,f=0;c(0,0)})}this._super(a,b)},notReadyAlert:function(){core.system.alertBox("Sorry, that function is not ready (yet).",!1)},fec:function(a){return this.element.find("._winnies_"+this.widgetName+"_"+a)},logging:function(a){this.doLog&&console.log(this.widgetName+" :: "+a)},_trigger:function(a,b,c){this._super(a,b,c)},_destroy:function(){this.crossIndex.destroy(),this.directoryTree.off(),$(core.system).off("filesystemchanged."+this.uniqueLabel),this._super()}});