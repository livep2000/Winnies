var appName="terminal";$.widget("apps."+appName,$.winnies.appDialog,{version:"1.0.0",sh:null,terminal:null,currentPrompt:null,echoOn:!0,promptOn:!0,options:{fontSize:"16Px",display:""},crop:function(){this.terminal.children().length>50&&this.terminal.find("div").first().remove()},postback:function(a){this.echoOn&&this.echoText(a),this.promptOn&&this.addPrompt()},addPrompt:function(){var a=this;this.currentPrompt&&(this.currentPrompt.attr("contenteditable","false"),this.currentPrompt.off("keydown"));var b=$("<div>");b.text(this.sh.fs.name+this.sh.pwd()+">"),this.currentPrompt=new $("<span>"),this.currentPrompt.attr("spellchecker","disabled"),this.currentPrompt.attr("contenteditable","true"),this.currentPrompt.attr("style","border:0Px;outline:0Px;min-width:1Px;padding-left:5Px;"),b.append(this.currentPrompt),this.terminal.append(b),this.crop(),this.terminal.focus(),this.currentPrompt.focus(),this.currentPrompt.bind("copy",function(){a.addPrompt()}),this.currentPrompt.on("keydown",function(b){if(13==b.which){var c=$(this).text();if(""==c)a.addPrompt();else try{var d=new Function(c);a.engine(d,a)}catch(e){a.postback(e.message)}b.preventDefault()}})},normalize:function(a){var b=this.sh.pwd();if("/"!=b&&(b+="/"),!a)var a="";var c=b+a;return c=c.replace("//","/"),console.log("Normalized: "+c),c},engine:function(a,b){supressPrompt=!1,hide=function(){b.terminal.hide()},show=function(){},launch=function(a,c,d){if(supressPrompt=!0,!c)var c={};core.app.launch(a,c,function(c,e){d&&d(c,e);var f=a+" launched.";c&&(f="Error: "+c),b.postback(f)})},kill=function(a,c){supressPrompt=!0,core.app.kill(a,function(d,e){c&&c(d,e);var f=a+" Killed.";d&&(f="Error: "+d),b.postback(f)})},promptOn=function(a){supressPrompt=!0,b.promptOn=!0,a||b.addPrompt()},promptOff=function(){b.promptOn=!1},echoWrite=function(a){supressPrompt=!0,b.postback(a)},echoOn=function(){b.echoOn=!0},echoOff=function(){b.echoOn=!1},help=function(){supressPrompt=!0,promptOff(),b.postback("****** HELP summary ******"),b.postback("promptOff(); ----------------------- Disable prompt."),b.postback("promptOn(); ------------------------ Enable prompt."),b.postback("echoOff(); ------------------------- Disable output."),b.postback("echoOn(); -------------------------- Enable output."),b.postback("echoWrite(text); ------------------- Write to output"),b.postback("help(); ---------------------------- This summary"),b.postback("install(fileName, path); ----------- Install app(s) by json file"),b.postback("install(Object, path); ------------- Install app(s) by object"),b.postback("uninstall(fileName, path); --------- Uninstall app(s) by json file"),b.postback("uninstall(Object, path); ----------- Uninstall app(s) by object"),b.postback("wget(url, path); ------------------- download file"),b.postback("format(driveName, callback); ------- Wipe drive"),b.postback("cd(path, callback); ---------------- Change directory"),b.postback("dir(path, callback); --------------- List directory"),b.postback("find(path, regex, callback);"),b.postback("ls(dir, [options], callback);"),b.postback("exec(path, [args], callback);"),b.postback("touch(path, [options], callback);"),b.postback("cat(files, callback);"),b.postback("rm(path, [options], callback);"),b.postback("tempDir(callback);"),b.postback("mkdirp(path, callback);"),b.postback("rename(oldPath, newPath, callback)"),b.postback("ftruncate(fd, len, callback)"),b.postback("truncate(path, len, callback)"),b.postback("stat(path, callback)"),b.postback("fstat(fd, callback)"),b.postback("lstat(path, callback)"),b.postback("exists(path, callback)"),b.postback("link(srcpath, dstpath, callback)"),b.postback("symlink(srcpath, dstpath, [type], callback)"),b.postback("readlink(path, callback)"),b.postback("unlink(path, callback)"),b.postback("mknod(path, mode, callback)"),b.postback("rmdir(path, callback)"),b.postback("mkdir(path, [mode], callback)"),b.postback("readdir(path, callback)"),b.postback("close(fd, callback)"),b.postback("open(path, flags, [mode], callback)"),b.postback("utimes(path, atime, mtime, callback)"),b.postback("futimes(fd, atime, mtime, callback)"),b.postback("write(fd, buffer, offset, length, position, callback)"),b.postback("read(fd, buffer, offset, length, position, callback)"),b.postback("readFile(filename, [options], callback)"),b.postback("writeFile(filename, data, [options], callback)"),b.postback("appendFile(filename, data, [options], callback)"),b.postback("setxattr(path, name, value, [flag], callback)"),b.postback("fsetxattr(fd, name, value, [flag], callback)"),b.postback("getxattr(path, name, callback)"),b.postback("fgetxattr(fd, name, callback)"),b.postback("removexattr(path, name, callback)"),b.postback("fremovexattr(fd, name, callback)"),b.postback("watch(filename, [options], [listener])"),promptOn()},cd=function(a,c){supressPrompt=!0,b.sh.cd(a,function(a){if(a)var d=a.message;c&&(a?c(a.message,null):c(null,!0)),a?b.postback(d):b.postback("changed to '"+b.sh.pwd()+"'")})},dir=function(a,c){supressPrompt=!0;var d=b.normalize(a);b.sh.fs.readdir(d,function(a,d){a&&(msg=a.message),c&&(a?c(a.message,null):c(null,d)),promptOff();for(key in d)b.postback(d[key]);promptOn()})},find=function(a,c,d){supressPrompt=!0;var e=b.normalize(a);b.sh.find(e,{regex:c},function(a,c){if(a)var e=a.message;if(d&&(a?d(a.message,null):d(null,c)),a)b.postback(e);else if(0==c.length)b.postback("Nothing found");else{promptOff(),b.postback("found in:");for(key in c)b.postback(c[key]);promptOn()}})},ls=function(a,c,d){supressPrompt=!0;var e=b.normalize(a);b.sh.ls(e,c,function(a,c){if(a)var e=a.message;if(d&&a&&d(a.message,c),a)b.postback(e);else{promptOff();for(key in c)b.postback("----------------------"),b.postback("path: "+c[key].path),b.postback("links: "+c[key].links),b.postback("size: "+c[key].size),b.postback("modified: "+core.util.timeConverter(c[key].modified)),b.postback("type: "+c[key].type),c[key].contents&&b.postback("content:"+c[key].contents.length);promptOn()}})},exec=function(a,c,d){supressPrompt=!0;var e=b.normalize(a);b.sh.fs.exec(e,c,function(a,c){if(a)var e=a.message;else var e=c;d&&(a?d(a.message,null):d(null,c)),b.postback(e)})},touch=function(a,c,d){supressPrompt=!0;var e=b.normalize(a);b.sh.touch(e,c,function(a){msg=e+" touched",a&&(msg=a.message),d&&a&&d(a.message,entries),b.postback(msg)})},cat=function(a,c){supressPrompt=!0,b.sh.cat(a,function(a,d){if(a){var e=a.message;b.postback(e)}else b.postback(d);c&&a&&c(a.message,d)})},rm=function(a,c,d){supressPrompt=!0;var e=b.normalize(a);b.sh.rm(e,c,function(a){msg=e+" removed",a&&(msg=a.message),d&&(a?d(a.message,null):d(null,!0)),b.postback(msg)})},tempdir=function(a){supressPrompt=!0,b.sh.tempDir(function(c,d){if(c)var e=c.message;else var e=d;a&&(c?a(c.message,null):a(null,d)),b.postback(e)})},mkdirp=function(a,c){supressPrompt=!0;var d=b.normalize(a);b.sh.mkdirp(d,function(a){msg=d+" created",a&&(msg=a.message),c&&a&&c(a.message,null),b.postback(msg)})},install=function(a,c){supressPrompt=!0,core.app.install(a,function(a,d,e,f,g){c&&c(a,result),a?b.postback(a):b.postback(d+" new apps installed.")})},format=function(a,c){supressPrompt=!0;var d="Drive "+a+" formatted";BVFS.format(a,function(a,e){a?(d=a,c&&c(a,e),b.postback(d)):b.sh.cd("/",function(f){c&&c(a,e),b.postback(d)})})},wget=function(a,c,d){supressPrompt=!0;var e=b.normalize(c),f=a.split("/"),g=f[f.length-1];g.startsWith("/")||(g="/"+g),b.sh.wget(a,e,function(a,c){var e=null;e=a?a.statusText+": Cannot get file.. statuscode: "+a.status:c,d&&d(a,c),b.postback(e)})},rename=function(a,c,d){supressPrompt=!0;var e=b.normalize(path),f=b.normalize(path);b.sh.fs.rename(e,f,function(a){var c=e+" is renamed to "+f;a&&(c=a.message),d&&(a?d(a.message,null):d(null,!0)),b.postback(c)})},ftruncate=function(a,c,d){supressPrompt=!0,b.sh.fs.ftruncate(a,c,function(a){var e=" truncate success.";a&&(e=a.message),d&&(a?d(a.message,null):d(null,c)),b.postback(e+" length = "+c)})},truncate=function(a,c,d){supressPrompt=!0;var e=b.normalize(a);b.sh.fs.truncate(e,c,function(a){var f=e+" truncated successfull, ";a&&(f=a.message),d&&(a?d(a.message,null):d(null,!0)),a?b.postback(f):b.postback(f+" length = "+c)})},stat=function(a,c){supressPrompt=!0;var d=b.normalize(a);b.sh.fs.stat(d,function(a,e){var f="Stats from "+d;a&&(f=a.message),c&&(a?c(a.message,null):c(null,e)),a?b.postback(f):(promptOff(),b.postback("---------------------------"),b.postback("node: "+e.node),b.postback("dev: "+e.dev),b.postback("size: "+e.size),b.postback("nlinks: "+e.nlinks),b.postback("atime: "+b.timeConverter(e.atime)),b.postback("mtime: "+b.timeConverter(e.mtime)),b.postback("ctime: "+b.timeConverter(e.ctime)),b.postback("type: "+e.type),promptOn())})},fstat=function(a,c){supressPrompt=!0,b.sh.fs.fstat(a,function(a,d){var e=" fstats";a&&(e=a.message),c&&(a?c(a.message,null):c(null,d)),b.postback(e)})},lstat=function(a,c){var d=b.normalize(a);supressPrompt=!0,b.sh.fs.lstat(d,function(a,d){var e=" lstats";a&&(e=a.message),c&&(a?c(a.message,null):c(null,d)),b.postback(e)})},exists=function(a,c){supressPrompt=!0;var d=b.normalize(a);b.sh.fs.exists(d,function(a){var e=d+" exists.";c&&c(null,a),a||(e=d+" does NOT exitst."),b.postback(e)})},link=function(a,c,d){supressPrompt=!0;var e=b.normalize(a),f=b.normalize(c);b.sh.fs.link(e,f,function(a){var c=e+" linked to "+f;a&&(c=a.message),d&&(a?d(a.message,null):d(null,!0)),b.postback(c)})},symlink=function(a,c,d,e){supressPrompt=!0,b.sh.fs.link(a,c,d,function(d,f){var g=a+" symlinked to "+c;d&&(g=d.message),e&&(d?e(d.message,null):e(null,!0)),b.postback(g)})},readlink=function(a,c){supressPrompt=!0,b.sh.fs.readlink(a,function(d,e){var f=a+" linkcontent";d&&(f=d.message),c&&(d?c(d.message,null):c(null,e)),b.postback(f)})},unlink=function(a,c){supressPrompt=!0,b.sh.fs.unlink(a,function(d){var e=a+"  unlinked";d&&(e=d.message),c&&(d?c(d.message,null):c(null,!0)),b.postback(e)})},mknod=function(a,c,d){supressPrompt=!0,b.sh.fs.mknod(a,c,function(c){var e=a+" lmknod success";c&&(e=c.message),d&&(c?d(c.message,null):d(null,!0)),b.postback(e)})},rmdir=function(a,c){supressPrompt=!0;var d=b.normalize(a);b.sh.fs.rmdir(d,function(a){var e=d+" removed";a&&(e=a.message),c&&(a?c(a.message,null):c(null,!0)),b.postback(e)})},mkdir=function(a,c,d){supressPrompt=!0;var e=b.sh.pwd();if(!a)var a="";b.sh.fs.mkdir(e+a,function(c){var e="'"+a+"' is created";c&&(e=a+" "+c.message),d&&(c?d(c.message,null):d(null,!0)),b.postback(e)})},readdir=function(a,c){supressPrompt=!0;var d=b.sh.pwd();if(!a)var a="";b.sh.fs.readdir(d+a,function(a,d){a&&(msg=a.message),c&&(a?c(a.message,null):c(null,d)),console.log(d),promptOff();for(key in d)b.postback(d[key]);promptOn()})},close=function(a,c){supressPrompt=!0,b.sh.fs.close(a,function(a){var d=" lfd closed";er&&(d=er.message),c&&(er?c(er.message,null):c(null,!0)),b.postback(d)})},open=function(a,c,d,e){supressPrompt=!0,b.sh.fs.open(a,c,d,function(c,d){var f=a+" opened";c&&(f=c.message),e&&(c?e(c.message,null):e(null,d)),b.postback(f)})},utimes=function(a,c,d,e){supressPrompt=!0,b.sh.fs.utimes(a,c,d,function(a){var f=c+" changed to "+d;a&&(f=a.message),e&&(a?e(a.message,null):e(null,!0)),b.postback(f)})},futimes=function(a,c,d,e){supressPrompt=!0,b.sh.fs.futimes(a,c,d,function(a){var f=c+" changed to "+d;a&&(f=a.message),e&&(a?e(a.message,null):e(null,!0)),b.postback(f)})},write=function(a,c,d,e,f,g){supressPrompt=!0,b.sh.fs.write(a,c,d,e,f,function(a,c){var d=c+" written.";a&&(d=a.message),g&&(a?g(a.message,null):g(null,c)),b.postback(d)})},read=function(a,c,d,e,f,g){supressPrompt=!0,b.sh.fs.read(a,c,d,e,f,function(a,c){var d=c+" read.";a&&(d=a.message),g&&(a?g(a.message,null):g(null,c)),b.postback(d)})},readFile=function(a,c,d){supressPrompt=!0,b.sh.fs.readFile(b.sh.pwd()+a,c,function(c,e){var f=a+" read.";c&&(f=c.message),d?c?d(c.message,null):d(null,e):b.postback(e)})},writeFile=function(a,c,d,e){supressPrompt=!0,b.sh.fs.writeFile(a,c,d,function(c){var d="written to "+a;c&&(d=c.message),e&&(c?e(c.message,null):e(null,!0)),b.postback(d)})},appendFile=function(a,c,d,e){supressPrompt=!0,b.sh.fs.writeFile(a,c,d,function(c){var d=a+" apended.";c&&(d=c.message),e&&(c?e(c.message,null):e(null,!0)),b.postback(d)})},setxattr=function(a,c,d,e,f){supressPrompt=!0,b.sh.fs.setxattr(a,c,d,e,function(a){var c=" xattribute set";a&&(c=a.message),f&&(a?f(a.message,null):f(null,!0)),b.postback(c)})},fsetxattr=function(a,c,d,e,f){supressPrompt=!0,b.sh.fs.fsetxattr(a,c,d,e,function(a){var c=" xattribute set";a&&(c=a.message),f&&(a?f(a.message,null):f(null,!0)),b.postback(c)})},getxattr=function(a,c,d){supressPrompt=!0,b.sh.fs.getxattr(a,c,function(a,e){var f=c+" = "+e;a&&(f=a.message),d&&(a?d(a.message,null):d(null,e)),b.postback(f)})},fgetxattr=function(a,c,d){supressPrompt=!0,b.sh.fs.getxattr(a,c,function(a,e){var f=c+" = "+e;a&&(f=a.message),d&&(a?d(a.message,null):d(null,e)),b.postback(f)})},removexattr=function(a,c,d){supressPrompt=!0,b.sh.fs.removexattr(a,c,function(a){var e=c+" removed.";a&&(e=a.message),d&&(a?d(a.message,null):d(null,!0)),b.postback(e)})},fremovexattr=function(a,c,d){supressPrompt=!0,b.sh.fs.fremovexattr(a,c,function(a){var e=c+" removed.";a&&(e=a.message),d&&(a?d(a.message,null):d(null,!0)),b.postback(e)})},watch=function(a,c,d){supressPrompt=!0,b.sh.fs.watch(a,c,d,function(a,c){var d="Watching "+c;er&&(d=er.message),callback&&(er?callback(er.message,null,null):callback(null,a,c)),b.postback(d)})};try{a&&(a(),0==supressPrompt&&(b.addPrompt(),supressPrompt=!0))}catch(c){b.postback(c.message),promptOn(!0)}},echoText:function(a){var b=$("<div>");b.css("color","#C0C0C0"),b.text(a),this.terminal.append(b),this.crop()},contentLoaded:function(a){this.terminal.height(a.size.innerHeight),this.element.append(this.terminal),this.addPrompt()},_create:function(){return this.terminal=$("<div>"),this.sh=new BVFS.fs.Shell,this.element.css("overflow","hidden"),this.terminal.empty(),this.terminal.css("font-size",this.options.fontSize),this.terminal.css("border-radius",5),this.terminal.css("color","yellow"),this.terminal.css("padding","10Px"),this.terminal.css("display",this.options.display),this.terminal.css("overflow-y","auto"),this.terminal.css("overflow-x","break-word"),this.terminal.css("background-color","black"),this.echoText("Browser Virtual File System. v 1.0.0"),this.echoText("Type: help(); for instructions."),this._super()},_trigger:function(a,b,c){return"close"==a&&this._destroy(),"resize"==a&&this.terminal.height(c.size.innerHeight),"focus"==a&&this.currentPrompt&&this.currentPrompt.focus(),"contentLoaded"==a&&this.contentLoaded(c),this._super(a,b,c)},_destroy:function(){return this._super()}});